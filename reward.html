<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim your reward!</title>
    <style>body { font-family: Arial; } </style>
    <script type="module">
        // Importa Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

        // Configuraci贸n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
            authDomain: "virtualblocks-b7a52.firebaseapp.com",
            databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com",
            projectId: "virtualblocks-b7a52",
            storageBucket: "virtualblocks-b7a52.firebasestorage.app",
            messagingSenderId: "490618182453",
            appId: "1:490618182453:web:93385819c7ff08537d8a7c"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const realtimeDB = getDatabase(app);
        const auth = getAuth(app);

        // Funci贸n para canjear c贸digo
        async function redeemGiftCard() {
            const code = document.getElementById("giftCode").value.trim();
            if (!code) {
                alert("Ingresa un c贸digo v谩lido.");
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                alert("Debes iniciar sesi贸n para canjear una tarjeta de regalo.");
                return;
            }

            const userId = user.uid;
            const codeRef = doc(firestore, "giftcards", code);
            const userRef = ref(realtimeDB, `users/${userId}/blocksgold`); //  CORREGIDO: Referencia correcta

            try {
                // Obtener el c贸digo de Firestore
                const codeSnap = await getDoc(codeRef);
                if (!codeSnap.exists()) {
                    alert("C贸digo inv谩lido o ya canjeado.");
                    return;
                }

                const amount = codeSnap.data().amount;
                
                // Obtener los Blocksgold actuales del usuario
                const userSnap = await get(userRef);
                let currentGold = userSnap.exists() ? userSnap.val() : 0;
                
                //  CORREGIDO: Se usa `set()` en lugar de `update()`
                await set(userRef, currentGold + amount);
                
                // Eliminar la giftcard despu茅s de usarla
                await deleteDoc(codeRef);

                alert(`Has recibido ${amount} BLOCKSGOLD`);
                document.getElementById("giftCode").value = ""; // Limpiar el campo
            } catch (error) {
                console.error("Error al canjear c贸digo:", error);
                alert("Hubo un problema al canjear el c贸digo.");
            }
        }

        // Verificar si el usuario est谩 autenticado
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("authStatus").innerText = `Bienvenido, ${user.email}`;
            } else {
                document.getElementById("authStatus").innerText = "No has iniciado sesi贸n.";
            }
        });

        // Hacer accesible la funci贸n en HTML
        window.redeemGiftCard = redeemGiftCard;
    </script>
</head>
<body>
    <h1>Canjear Tarjeta de Regalo</h1>
    <p id="authStatus">Verificando autenticaci贸n...</p>
    
    <input type="text" id="giftCode" placeholder="Ingresa el c贸digo aqu铆">
    <button onclick="redeemGiftCard()">Canjear</button>
</body>
</html>
