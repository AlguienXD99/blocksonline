<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battlegrounds - BLOCKSONLINE</title>
    <style>
        body { margin: 0; overflow: hidden; background: white; }
        canvas { display: block; }
        #leaderboard {
            position: absolute;
            top: 10px;
            left: 500px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
        }
        #gui {
            position: absolute;
            top: 500px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            cursor: pointer;
        }
        canvas:hover {
            cursor: url('cursor.png'), auto;
        }
        #gameContainer {
            background: linear-gradient(to bottom, skyblue 50%, gray 50%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            background-image: url('fondo.png');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        button {
            background-color: black;
            color: white;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
</div>

<div id="leaderboard">Leaderboard</div>
<div id="gui">[E] Equipar/Desequipar Espada | [Espacio] Atacar</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

<script>
// Configuración Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
  authDomain: "virtualblocks-b7a52.firebaseapp.com",
  databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com",
  projectId: "virtualblocks-b7a52",
  storageBucket: "virtualblocks-b7a52.firebasestorage.app",
  messagingSenderId: "490618182453",
  appId: "1:490618182453:web:93385819c7ff08537d8a7c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let firebaseError = ""; // Variable para errores de Firebase

// Imágenes
const backgroundImg = new Image();
backgroundImg.src = "fondo.png";
const playerImg = new Image();
playerImg.src = "player.png";
const swordImg = new Image();
swordImg.src = "https://tr.rbxcdn.com/463a028944c35811cdcd881b3a3a444b/420/420/Decal/Png";

// Jugador
let player = { 
    id: null, 
    x: Math.random() * canvas.width, 
    y: Math.random() * canvas.height, 
    size: 50, 
    name: "", 
    health: 100, 
    hasSword: false 
};
let players = {};
let targetX = player.x, targetY = player.y;
let playerItems = {};

auth.onAuthStateChanged(user => {
    if (user) {
        player.id = user.uid;
        
        // Obtenemos el nickname desde Firebase
     db.ref(`users/${user.uid}/nickname`).once("value", snapshot => {
            const nickname = snapshot.val() || "Anónimo"; // Si no hay nickname, usamos "Anónimo"
            player.name = nickname;

            // Guardamos el jugador en la base de datos
     db.ref(`players/${player.id}`).set(player).catch(error => {
                firebaseError = error.message; // Captura errores de autenticación
            });
        });
        window.addEventListener("mousemove", e => {
            targetX = e.clientX;
            targetY = e.clientY;
        });

        window.addEventListener("beforeunload", () => {
            db.ref(`players/${player.id}`).remove().catch(error => {
                firebaseError = error.message;
            });
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "e") toggleSword();
            if (e.key === " ") attack();
        });

        gameLoop(); // Iniciar el bucle de juego al cargar
    } else {
        firebaseError = "No se ha iniciado sesión.";
    }
});

function toggleSword() {
    player.hasSword = !player.hasSword;
    db.ref(`players/${player.id}/hasSword`).set(player.hasSword);
}

function attack() {
    if (!player.hasSword) return;
    for (const id in players) {
        if (id !== player.id) {
            const enemy = players[id];
            const distance = Math.hypot(player.x - enemy.x, player.y - enemy.y);
            if (distance < 60) {
                let newHealth = Math.max(0, enemy.health - 20);
                db.ref(`players/${id}/health`).set(newHealth);

                if (newHealth === 0) {
                    db.ref(`players/${id}`).set({ 
                        id: id, 
                        x: Math.random() * canvas.width, 
                        y: Math.random() * canvas.height, 
                        size: 50, 
                        name: enemy.name, 
                        health: 100, 
                        hasSword: false 
                    });
                }
            }
        }
    }
}

function updateLeaderboard() {
    const leaderboard = document.getElementById("leaderboard");
    leaderboard.innerHTML = "<b>Leaderboard</b><br>";
    for (const id in players) {
        const p = players[id];
        leaderboard.innerHTML += `${p.name}: ${p.health} HP<br>`;
    }
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpiar el lienzo
    ctx.drawImage(backgroundImg, 0, 0, canvas.width, canvas.height);

    player.x += (targetX - player.x) * 0.05;
    player.y += (targetY - player.y) * 0.05;

    for (const id in players) {
        const p = players[id];
        ctx.drawImage(playerImg, p.x - 25, p.y - 25, 50, 50);

        ctx.fillStyle = "black";
        ctx.font = "14px Arial";
        ctx.fillText(p.name, p.x - 20, p.y - 30);
        ctx.fillText(`HP: ${p.health}`, p.x - 20, p.y + 40);

        if (p.hasSword) {
            ctx.drawImage(swordImg, p.x + 15, p.y, 40, 40);
        }
    }

    if (firebaseError) {
        ctx.fillStyle = "red";
        ctx.font = "16px Arial";
        ctx.fillText(`Error: ${firebaseError}`, 10, canvas.height - 20);
    }

    requestAnimationFrame(gameLoop); // Continuar el bucle
}

// Actualizar la base de datos cada segundo
setInterval(() => {
    db.ref(`players/${player.id}`).set(player);
}, 1000);

</script>

<div id="controls">
    <button id="equipButton">Equipar Espada</button>
    <button id="unequipButton">Desequipar Espada</button>
    <button id="attackButton">Atacar</button>
</div>

</body>
</html>
