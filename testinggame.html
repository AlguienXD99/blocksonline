<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOCKSONLINE</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, update, onChildAdded, onChildChanged, onChildRemoved, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import * as THREE from "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
            authDomain: "virtualblocks-b7a52.firebaseapp.com",
            databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com",
            projectId: "virtualblocks-b7a52",
            storageBucket: "virtualblocks-b7a52.appspot.com",
            messagingSenderId: "490618182453",
            appId: "1:490618182453:web:93385819c7ff08537d8a7c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let players = {};
        
        document.getElementById("loginForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Usuario autenticado:", userCredential.user);
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("loginContainer").style.display = "none";
                initGame(user.uid);
            }
        });

        function initGame(playerId) {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const baseplate = new THREE.Mesh(
                new THREE.BoxGeometry(20, 1, 20),
                new THREE.MeshBasicMaterial({ color: 0x888888 })
            );
            baseplate.position.y = -1;
            scene.add(baseplate);

            function addPlayer(id, position) {
                if (!players[id]) {
                    const playerMesh = new THREE.Mesh(
                        new THREE.BoxGeometry(1, 2, 1),
                        new THREE.MeshBasicMaterial({ color: id === playerId ? 0x00ff00 : 0xff0000 })
                    );
                    scene.add(playerMesh);
                    players[id] = playerMesh;
                }
                players[id].position.set(position.x, position.y, position.z);
            }

            function removePlayer(id) {
                if (players[id]) {
                    scene.remove(players[id]);
                    delete players[id];
                }
            }

            onChildAdded(ref(db, "players"), (snapshot) => {
                const data = snapshot.val();
                if (data.connected) addPlayer(snapshot.key, data.position);
            });

            onChildChanged(ref(db, "players"), (snapshot) => {
                const data = snapshot.val();
                if (data.connected) {
                    if (players[snapshot.key]) {
                        players[snapshot.key].position.set(data.position.x, data.position.y, data.position.z);
                    } else {
                        addPlayer(snapshot.key, data.position);
                    }
                } else {
                    removePlayer(snapshot.key);
                }
            });

            onChildRemoved(ref(db, "players"), (snapshot) => {
                removePlayer(snapshot.key);
            });

            const player = new THREE.Mesh(
                new THREE.BoxGeometry(1, 2, 1),
                new THREE.MeshBasicMaterial({ color: 0x00ff00 })
            );
            scene.add(player);
            camera.position.set(0, 2, 5);
            
            let keys = {};
            let velocity = { x: 0, y: 0, z: 0 };
            const gravity = -0.02;
            let onGround = false;

            window.addEventListener("keydown", (event) => keys[event.key] = true);
            window.addEventListener("keyup", (event) => keys[event.key] = false);

            function updatePlayer() {
                if (keys['w']) player.position.z -= 0.1;
                if (keys['s']) player.position.z += 0.1;
                if (keys['a']) player.position.x -= 0.1;
                if (keys['d']) player.position.x += 0.1;
                if (keys[' '] && onGround) {
                    velocity.y = 0.5;
                    onGround = false;
                }
                velocity.y += gravity;
                player.position.y += velocity.y;
                if (player.position.y <= baseplate.position.y + 1) {
                    player.position.y = baseplate.position.y + 1;
                    velocity.y = 0;
                    onGround = true;
                }

                update(ref(db, `players/${playerId}`), {
                    position: { x: player.position.x, y: player.position.y, z: player.position.z },
                    connected: true
                });
            }

            function countActivePlayers() {
                onChildAdded(ref(db, "players"), (snapshot) => {
                    let playerCount = Object.keys(players).length - 1;
                    console.log(`Otros jugadores activos: ${playerCount}`);
                });

                onChildRemoved(ref(db, "players"), (snapshot) => {
                    let playerCount = Object.keys(players).length - 1;
                    console.log(`Otros jugadores activos: ${playerCount}`);
                });
            }

            function animate() {
                requestAnimationFrame(animate);
                updatePlayer();
                renderer.render(scene, camera);
            }
            animate();
            countActivePlayers();

            onDisconnect(ref(db, `players/${playerId}`)).update({ connected: false }).then(() => {
                remove(ref(db, `players/${playerId}`));
            });
        }
    </script>
</head>
<body style="margin:0; overflow:hidden;">
    <div id="loginContainer" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <h2>Iniciar sesión</h2>
        <form id="loginForm">
            <input type="email" id="email" placeholder="Correo electrónico" required>
            <input type="password" id="password" placeholder="Contraseña" required>
            <button type="submit">Ingresar</button>
        </form>
    </div>
</body>
</html>
