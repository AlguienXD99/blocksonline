<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VirtualBlocks Multiplayer</title>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.174.0/build/three.module.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js';
        import { getDatabase, ref, onValue, set, remove } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
            authDomain: "virtualblocks-b7a52.firebaseapp.com",
            databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com",
            projectId: "virtualblocks-b7a52",
            storageBucket: "virtualblocks-b7a52.appspot.com",
            messagingSenderId: "490618182453",
            appId: "1:490618182453:web:93385819c7ff08537d8a7c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        camera.position.z = 5;

        const players = {};
        let currentUser = null;

        function createCube(color) {
            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshBasicMaterial({ color });
            return new THREE.Mesh(geometry, material);
        }

        function updatePlayers(snapshot) {
            const data = snapshot.val();
            for (const id in players) {
                if (!data || !data[id]) {
                    scene.remove(players[id]);
                    delete players[id];
                }
            }
            for (const id in data) {
                if (!players[id]) {
                    const cube = createCube(data[id].color || 0x0000ff);
                    players[id] = cube;
                    scene.add(cube);
                }
                if (data[id].position) {
                    players[id].position.set(data[id].position.x, data[id].position.y, data[id].position.z);
                }
            }
        }

        onValue(ref(db, '/players'), updatePlayers);

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        function login(email, password) {
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    const playerRef = ref(db, `/players/${currentUser.uid}`);
                    set(playerRef, { nickname: currentUser.email, color: 0x0000ff, position: { x: 0, y: 0, z: 0 } });
                })
                .catch(console.error);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                set(ref(db, `/players/${user.uid}`), { nickname: user.email, color: 0x0000ff, position: { x: 0, y: 0, z: 0 } });
            } else if (currentUser) {
                remove(ref(db, `/players/${currentUser.uid}`));
                currentUser = null;
            }
        });

        window.login = login;

        document.addEventListener('keydown', (event) => {
            if (!currentUser || !players[currentUser.uid]) return;
            
            const playerRef = ref(db, `/players/${currentUser.uid}/position`);
            const speed = 0.1;
            let pos = { ...players[currentUser.uid].position };

            switch (event.key.toLowerCase()) {
                case 'w': pos.z -= speed; break;
                case 's': pos.z += speed; break;
                case 'a': pos.x -= speed; break;
                case 'd': pos.x += speed; break;
            }

            set(playerRef, pos);
        });
    window.login = login;
    </script>
</head>
<body>
    <h1>VirtualBlocks Multiplayer</h1>
    <p>Ingresa tu email y contraseña para jugar:</p>
    <input type="text" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Contraseña">
    <button onclick="login(document.getElementById('email').value, document.getElementById('password').value)">Ingresar</button>
</body>
</html>
