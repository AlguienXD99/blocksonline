<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOCKSONLINE</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import * as THREE from "https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.min.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
            authDomain: "virtualblocks-b7a52.firebaseapp.com",
            databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com/",
            projectId: "virtualblocks-b7a52",
            storageBucket: "virtualblocks-b7a52.appspot.com",
            messagingSenderId: "490618182453",
            appId: "1:490618182453:web:93385819c7ff08537d8a7c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let playerId = Math.random().toString(36).substr(2, 9);
        const playerRef = ref(db, `players/${playerId}`);
        
        window.addEventListener("beforeunload", () => remove(playerRef));

        document.body.innerHTML = '<div id="loading">Cargando...</div>';
        setTimeout(() => {
            document.getElementById("loading").remove();
            startGame();
        }, 2000);

        function startGame() {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const baseGeometry = new THREE.BoxGeometry(20, 1, 20);
            const baseMaterial = new THREE.MeshBasicMaterial({ color: 0x808080 });
            const baseplate = new THREE.Mesh(baseGeometry, baseMaterial);
            baseplate.position.y = -1;
            scene.add(baseplate);

            const players = {};
            function addPlayer(id, position) {
                if (!players[id]) {
                    const playerGeometry = new THREE.BoxGeometry(1, 2, 1);
                    const playerMaterial = new THREE.MeshBasicMaterial({ color: id === playerId ? 0x00ff00 : 0xff0000 });
                    const playerMesh = new THREE.Mesh(playerGeometry, playerMaterial);
                    playerMesh.position.set(position.x, position.y, position.z);
                    scene.add(playerMesh);
                    players[id] = playerMesh;
                }
            }

            function removePlayer(id) {
                if (players[id]) {
                    scene.remove(players[id]);
                    delete players[id];
                }
            }

            function updatePlayers(snapshot) {
                snapshot.forEach(child => {
                    const data = child.val();
                    if (data.connected) {
                        addPlayer(child.key, data.position);
                        players[child.key].position.set(data.position.x, data.position.y, data.position.z);
                    } else {
                        removePlayer(child.key);
                    }
                });
            }

            onValue(ref(db, "players"), updatePlayers);

            const playerGeometry = new THREE.BoxGeometry(1, 2, 1);
            const playerMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const player = new THREE.Mesh(playerGeometry, playerMaterial);
            scene.add(player);
            camera.position.set(0, 2, 5);

            let keys = {};
            let velocity = { x: 0, y: 0, z: 0 };
            const gravity = -0.02;
            const jumpStrength = 0.5;
            let onGround = false;

            window.addEventListener("keydown", (event) => keys[event.key] = true);
            window.addEventListener("keyup", (event) => keys[event.key] = false);

            function updatePlayer() {
                if (keys['w']) player.position.z -= 0.1;
                if (keys['s']) player.position.z += 0.1;
                if (keys['a']) player.position.x -= 0.1;
                if (keys['d']) player.position.x += 0.1;

                if (keys[' '] && onGround) {
                    velocity.y = jumpStrength;
                    onGround = false;
                }

                velocity.y += gravity;
                player.position.y += velocity.y;

                if (player.position.y <= baseplate.position.y + 1) {
                    player.position.y = baseplate.position.y + 1;
                    velocity.y = 0;
                    onGround = true;
                }

                set(playerRef, { position: { x: player.position.x, y: player.position.y, z: player.position.z }, connected: true });
            }

            function animate() {
                requestAnimationFrame(animate);
                updatePlayer();
                renderer.render(scene, camera);
            }
            animate();
        }
    </script>
</head>
<body style="margin:0; overflow:hidden;">
    <button id="closeGame" style="position: absolute; top: 10px; left: 10px;">Cerrar juego</button>
    <script>
        document.getElementById("closeGame").addEventListener("click", () => location.reload());
    </script>
</body>
</html>
