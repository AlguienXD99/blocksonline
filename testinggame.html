<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego Multijugador 3D - Blocksonline</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: white; overflow: hidden; }
        canvas { display: block; }
        #leaderboard { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(0, 0, 0, 0.7); 
            color: white; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
<div id="leaderboard">Leaderboard</div>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyAZM_UTKUtkjoXSmhAU2yFaWTgt9oUwktA",
    authDomain: "virtualblocks-servers.firebaseapp.com",
    databaseURL: "https://virtualblocks-servers-default-rtdb.firebaseio.com",
    projectId: "virtualblocks-servers",
    storageBucket: "virtualblocks-servers.appspot.com",
    messagingSenderId: "796633829717",
    appId: "1:796633829717:web:fcbd2d376565b0160e1fdc"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let scene, camera, renderer, playerMesh;
let players = {};

const canvas = document.createElement("canvas");
document.body.appendChild(canvas);
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

auth.onAuthStateChanged(user => {
    if (user) {
        player.id = user.uid;
        player.name = user.displayName || "AnÃ³nimo";
        loadPlayerData(player.id);
        createMainPlayer(player.id);
        listenForPlayerMoves(player.id);
        gameLoop();
    } else {
        window.location.href = "index.html";
    }
});

function loadPlayerData(uid) {
    const userRef = db.ref("players/" + uid);
    userRef.on("value", snapshot => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            players[uid] = data;
            updateLeaderboard();
        }
    });
}

function createMainPlayer(uid) {
    playerMesh = new THREE.Mesh(
        new THREE.SphereGeometry(1),
        new THREE.MeshBasicMaterial({ color: Math.random() * 0xffffff })
    );
    playerMesh.name = uid;
    scene.add(playerMesh);
    playerMesh.position.set(0, 1, 0);
    camera.position.z = 5;
    movePlayer(uid, playerMesh.position);
}

function movePlayer(uid, position) {
    const playerRef = db.ref("players/" + uid);
    playerRef.update({ position });
}

function listenForPlayerMoves(uid) {
    const playerRef = db.ref("players/" + uid);
    playerRef.on("value", snapshot => {
        if (snapshot.exists()) {
            const playerData = snapshot.val();
            updatePlayerPosition(uid, playerData.position);
        }
    });
}

function updatePlayerPosition(uid, position) {
    const playerElement = scene.getObjectByName(uid);
    if (playerElement) {
        playerElement.position.set(position.x, position.y, position.z);
    }
}

function updateLeaderboard() {
    const leaderboard = document.getElementById("leaderboard");
    leaderboard.innerHTML = "<b>Leaderboard</b><br>";
    const sorted = Object.values(players).sort((a, b) => b.score - a.score);
    sorted.forEach(p => {
        leaderboard.innerHTML += `${p.name}: ${p.score} puntos<br>`;
    });
}

function gameLoop() {
    if (!scene) {
        initThreeJS();
    }
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    updatePlayerPositions();
    renderThreeJS();
    requestAnimationFrame(gameLoop);
}

function initThreeJS() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
}

function updatePlayerPositions() {
    Object.keys(players).forEach(uid => {
        const p = players[uid];
        const playerElement = scene.getObjectByName(uid);
        if (playerElement) {
            playerElement.position.set(p.position.x, p.position.y, p.position.z);
        }
    });
}

function renderThreeJS() {
    renderer.render(scene, camera);
}
</script>
</body>
</html>
