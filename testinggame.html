<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego VirtualBlocks</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script type="module">
        // Importar Firebase desde el CDN (modular)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js';

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
            authDomain: "virtualblocks-b7a52.firebaseapp.com",
            databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com",
            projectId: "virtualblocks-b7a52",
            storageBucket: "virtualblocks-b7a52.firebasestorage.app",
            messagingSenderId: "490618182453",
            appId: "1:490618182453:web:93385819c7ff08537d8a7c"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Configurar escena Three.js
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Crear cubo (personaje) como avatar
        let playerId = "player1"; // Este ID será único para cada jugador
        let characterGeometry = new THREE.BoxGeometry(1, 1, 1);
        let characterMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        let character = new THREE.Mesh(characterGeometry, characterMaterial);
        scene.add(character);

        // Posición inicial de la cámara
        camera.position.z = 5;

        // Guardar posición del jugador en Firebase
        function updatePosition(playerId, position) {
            set(ref(db, 'players/' + playerId), {
                x: position.x,
                y: position.y,
                z: position.z
            });
        }

        // Leer posiciones de otros jugadores en Firebase
        const players = {}; // Guardamos los jugadores en un mapa
        onValue(ref(db, 'players'), (snapshot) => {
            const playersData = snapshot.val();
            for (let playerId in playersData) {
                const player = playersData[playerId];
                if (!players[playerId]) {
                    // Crear un nuevo jugador si no existe
                    let otherPlayer = new THREE.Mesh(
                        new THREE.BoxGeometry(1, 1, 1),
                        new THREE.MeshBasicMaterial({ color: 0x0000ff })
                    );
                    players[playerId] = otherPlayer;
                    scene.add(otherPlayer);
                }
                // Actualizar la posición de los jugadores
                players[playerId].position.set(player.x, player.y, player.z);
            }
        });

        // Movimiento básico del personaje con las teclas
        let moveSpeed = 0.1;
        window.addEventListener("keydown", (event) => {
            if (event.key === "ArrowUp") character.position.z -= moveSpeed;
            if (event.key === "ArrowDown") character.position.z += moveSpeed;
            if (event.key === "ArrowLeft") character.position.x -= moveSpeed;
            if (event.key === "ArrowRight") character.position.x += moveSpeed;
            // Actualizar la posición en Firebase
            updatePosition(playerId, character.position);
        });

        // Animación del juego
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        // Ajuste del tamaño de la ventana
        window.addEventListener("resize", () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>

    <!-- Cargar Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
</body>
</html>
