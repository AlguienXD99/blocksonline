<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing</title>
    <style>
        body { margin: 0; background: white; overflow: hidden; }
        canvas { display: block; }
        #leaderboard { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(0, 0, 0, 0.7); 
            color: white; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="leaderboard">Leaderboard</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
  authDomain: "virtualblocks-b7a52.firebaseapp.com",
  databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com",
  projectId: "virtualblocks-b7a52",
  storageBucket: "virtualblocks-b7a52.firebasestorage.app",
  messagingSenderId: "490618182453",
  appId: "1:490618182453:web:93385819c7ff08537d8a7c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const images = ["player.png"];
let player = { id: null, x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 30, image: "", name: "", score: 0 };
let players = {};
let points = [];
let targetX = player.x;
let targetY = player.y;
let hasLost = false;

function signInWithEmail() {
    const email = prompt("Ingrese su correo electrónico:");
    const password = prompt("Ingrese su contraseña:");

    auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
            console.log("Inicio de sesión exitoso");
        })
        .catch(error => {
            if (error.code === "auth/user-not-found") {
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        console.log("Cuenta creada exitosamente");
                    })
                    .catch(error => {
                        console.error("Error al registrar:", error.message);
                    });
            } else {
                console.error("Error de autenticación:", error.message);
            }
        });
}

auth.onAuthStateChanged(user => {
    if (user) {
        player.id = user.uid;
        player.name = user.email.split("@")[0] || "Anónimo"; 
        player.image = images[Math.floor(Math.random() * images.length)];
        db.ref(`players/${player.id}`).set(player);

        db.ref("players").on("value", snapshot => {
            players = snapshot.val() || {};
            updateLeaderboard();
        });

        db.ref("points").once("value", snapshot => {
            points = snapshot.val() || [];
            if (points.length === 0) generatePoints();
        });

        window.addEventListener("mousemove", e => {
            targetX = e.clientX;
            targetY = e.clientY;
        });

        window.addEventListener("beforeunload", () => {
            db.ref(`players/${player.id}`).remove().then(() => checkEmptyServer());
        });

        setInterval(spawnPoints, 60000);
        gameLoop();
    } else {
        signInWithEmail();
    }
});

function generatePoints() {
    points = [];
    for (let i = 0; i < 100; i++) {
        points.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 5 });
    }
    db.ref("points").set(points);
}

function spawnPoints() {
    for (let i = 0; i < 20; i++) {
        points.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 5 });
    }
    db.ref("points").set(points);
}

function checkEmptyServer() {
    db.ref("players").once("value", snapshot => {
        if (!snapshot.exists()) generatePoints();
    });
}

function updateLeaderboard() {
    const leaderboard = document.getElementById("leaderboard");
    leaderboard.innerHTML = "<b>Leaderboard</b><br>";
    const sorted = Object.values(players).sort((a, b) => b.score - a.score);
    sorted.forEach(p => {
        leaderboard.innerHTML += `${p.name}: ${p.score} puntos<br>`;
    });
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    player.x += (targetX - player.x) * 0.02;
    player.y += (targetY - player.y) * 0.02;

    points.forEach(p => {
        ctx.fillStyle = "green";
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
    });

    for (const id in players) {
        const p = players[id];
        const img = new Image();
        img.src = p.image;

        ctx.drawImage(img, p.x - p.size, p.y - p.size, p.size * 2, p.size * 2);
        ctx.fillStyle = "black";
        ctx.fillText(p.name, p.x - 20, p.y - p.size - 10);
    }

    requestAnimationFrame(gameLoop);
}

// Se actualiza solo si hay cambios significativos
setInterval(() => {
    db.ref(`players/${player.id}`).set(player);
}, 1000);
</script>
</body>
</html>
