<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battlegrounds - BLOCKSONLINE</title>
    <style>
        body { margin: 0; overflow: hidden; background: white; }
        canvas { display: block; }
        #leaderboard {
            position: absolute;
            top: 10px;
            left: 500px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
        }
        #gui {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
        }
        #gui {
            top: 500px;
            cursor: pointer;
        }
    canvas:hover {
        cursor: url('cursor.png'), auto;
     }
    </style>
</head>
<body>
<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
</div>

<style>
   #gameContainer {
    background: linear-gradient(to bottom, skyblue 50%, gray 50%); /* Degradado de celeste a gris */
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh; /* Toda la pantalla */
    width: 100vw; /* Todo el ancho */

    /* Corrección de background-image */
    background-image: url('fondo.png'); 
    background-repeat: no-repeat;
    background-size: cover; /* Ajusta la imagen para cubrir todo el contenedor */
    background-position: center; /* Centra la imagen */
}

</style>

<div id="leaderboard">Leaderboard</div>
<div id="gui">[E] Equipar/Desequipar Espada | [Espacio] Atacar</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

<script>
// Configuración Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
  authDomain: "virtualblocks-b7a52.firebaseapp.com",
  databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com",
  projectId: "virtualblocks-b7a52",
  storageBucket: "virtualblocks-b7a52.firebasestorage.app",
  messagingSenderId: "490618182453",
  appId: "1:490618182453:web:93385819c7ff08537d8a7c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
    
const speed = 5; // Asegúrate de que 'speed' esté declarado antes de cualquier uso
const canvas = document.getElementById("gameCanvas");
    
// Cargar la imagen de fondo
const backgroundImg = new Image();
backgroundImg.src = "fondo.png"; // Asegúrate de tener la imagen en la carpeta correcta
backgroundImg.onload = () => {
    gameLoop(); // Iniciar el juego solo cuando la imagen de fondo haya cargado
};

// Cargar la configuración del usuario desde Firebase Realtime Database
async function loadUserConfig(userUID) {
    try {
        // Referencia a la base de datos en Firebase
        const userRef = firebase.database().ref('users/' + userUID); // Ajusta la ruta si es necesario
        const snapshot = await userRef.once('value');  // Obtén una sola lectura

        // Verifica si los datos existen para este UID
        if (snapshot.exists()) {
            return snapshot.val();  // Devuelve los datos de configuración
        } else {
            console.warn(`No se encontraron datos para el usuario ${userUID}`);
            return null;
        }
    } catch (error) {
        console.error("Error al cargar la configuración del usuario desde Firebase:", error);
        return null;
    }
}

// Objetos globales para almacenar datos del jugador e imágenes
const playerData = {};
const itemImages = {};
let currentUserUID = null;
let debugMode = true; // Activar para ver logs de depuración

// Cargar configuración del usuario de forma asíncrona una vez, no en cada frame
async function initializePlayer(uid) {
    try {
        if (debugMode) console.log(`Inicializando jugador con UID: ${uid}`);
        currentUserUID = uid;
        
        // Cargar datos del jugador
        const playersRef = db.ref('players');
        const playerSnapshot = await playersRef.child(uid).once('value');
        let plyr = playerSnapshot.val();
        
        if (debugMode) console.log("Datos del jugador cargados:", plyr);
        
        if (!plyr) {
            if (debugMode) console.log("Creando nuevo jugador");
            // Si no existe el jugador, inicializarlo con datos predeterminados
            plyr = {
                id: uid,
                x: 100,
                y: 100,
                equippedItems: {},
                userUID: uid, // Asegurarse de que userUID está definido
                name: "Jugador", // Nombre por defecto
                health: 100 // Salud por defecto
            };
            await playersRef.child(uid).set(plyr);
        }
        
        // Asegurarse de que userUID está definido
        if (!plyr.userUID) {
            plyr.userUID = uid;
            await playersRef.child(uid).update({ userUID: uid });
        }
        
        // Guardar datos en el objeto global
        playerData[uid] = plyr;
        
        // Importante: También registrar este jugador en el objeto 'players' usado en gameLoop
        // Este puede ser el problema - si 'players' no está sincronizado con 'playerData'
        if (typeof players === 'object') {
            players[uid] = plyr;
            if (debugMode) console.log("Jugador registrado en objeto players:", players[uid]);
        } else {
            console.error("Error: 'players' no está definido correctamente");
        }
        
        // Cargar configuración de usuario
        const userConfigRef = db.ref(`users/${uid}`);
        const userConfigSnapshot = await userConfigRef.once('value');
        const userConfig = userConfigSnapshot.val() || {};
        
        if (debugMode) console.log("Configuración de usuario cargada:", userConfig);
        
        // Guardar configuración en el objeto global
        playerData[uid].userConfig = userConfig;
        
        // Precarga de imágenes de ítems
        const items = ['item1', 'item2', 'item3'];
        
        if (debugMode) console.log("Iniciando carga de imágenes de ítems...");
        
        for (const item of items) {
            const itemRef = db.ref(`users/${uid}/equippedItems/${item}`);
            const itemSnapshot = await itemRef.once('value');
            const itemData = itemSnapshot.val();
            
            if (debugMode) console.log(`Datos del ítem ${item}:`, itemData);
            
            if (itemData && itemData.imageUrl) {
                // Cargar la imagen solo una vez
                try {
                    await loadItemImage(item, itemData.imageUrl, itemData.position || 'torso');
                    if (debugMode) console.log(`Imagen cargada exitosamente: ${item}`);
                } catch (err) {
                    console.error(`Error cargando imagen ${item}:`, err);
                }
            } else {
                if (debugMode) console.log(`No hay datos para el ítem ${item} o falta imageUrl`);
            }
        }
        
        if (debugMode) {
            console.log("Estado final de itemImages:", 
                        Object.keys(itemImages).map(key => ({ 
                            key, 
                            hasImage: !!itemImages[key].image,
                            position: itemImages[key].position
                        })));
        }
        
        // Iniciar el bucle del juego una vez que todo está cargado
        if (debugMode) console.log("Iniciando bucle del juego");
        requestAnimationFrame(gameLoop);
    } catch (error) {
        console.error("Error al inicializar jugador:", error);
    }
}

// Función para cargar imágenes de forma asíncrona
function loadItemImage(itemId, imageUrl, position) {
    if (debugMode) console.log(`Cargando imagen para ${itemId}: ${imageUrl}`);
    
    return new Promise((resolve, reject) => {
        const img = new Image();
        
        // Importante: agregar timeout para evitar esperas infinitas
        const timeout = setTimeout(() => {
            if (debugMode) console.error(`Timeout al cargar imagen para ${itemId}`);
            reject(new Error(`Timeout al cargar imagen: ${imageUrl}`));
        }, 10000); // 10 segundos de timeout
        
        img.onload = () => {
            clearTimeout(timeout);
            if (debugMode) console.log(`Imagen cargada para ${itemId}: ${img.width}x${img.height}`);
            
            // Guardar la imagen y su posición en el objeto global
            itemImages[itemId] = {
                image: img,
                position: position
            };
            resolve();
        };
        
        img.onerror = () => {
            clearTimeout(timeout);
            console.error(`Error al cargar imagen para ${itemId}: ${imageUrl}`);
            reject(new Error(`No se pudo cargar la imagen: ${imageUrl}`));
        };
        
        // Verificar si la URL es válida
        if (!imageUrl || !imageUrl.startsWith('http')) {
            console.error(`URL de imagen inválida para ${itemId}: ${imageUrl}`);
            reject(new Error(`URL de imagen inválida: ${imageUrl}`));
            return;
        }
        
        // Set crossOrigin to allow images from different domains
        img.crossOrigin = "Anonymous";
        img.src = imageUrl;
    });
}

// Función principal del bucle del juego
function gameLoop() {
    try {
        // Dibujar la imagen de fondo
        ctx.drawImage(backgroundImg, 0, 0, canvas.width, canvas.height);

        // Suavizar el movimiento del jugador actual
        if (player && targetX !== undefined && targetY !== undefined) {
            player.x += (targetX - player.x) * 0.1;
            player.y += (targetY - player.y) * 0.1;
        }

        // Dibujar todos los jugadores
        for (const id in players) {
            let p = players[id];
            
            // Verificar que el jugador tiene datos válidos
            if (!p || !p.userUID) {
                if (debugMode) console.warn(`Jugador ${id} no tiene datos válidos:`, p);
                continue;
            }
            
            // Dibujar el avatar del jugador
            try {
                ctx.drawImage(playerImg, p.x - 25, p.y - 25, 50, 50);
            } catch (e) {
                console.error("Error dibujando avatar del jugador:", e);
            }

            // Dibujar nombre y vida
            ctx.fillStyle = "black";
            ctx.font = "14px Arial";
            ctx.fillText(p.name || "Sin nombre", p.x - 20, p.y - 30);
            ctx.fillText(`HP: ${p.health || 0}`, p.x - 20, p.y + 40);

            // Dibujar espada si la tiene equipada
            if (p.hasSword) {
                try {
                    ctx.drawImage(swordImg, p.x + 15, p.y, 40, 40);
                } catch (e) {
                    console.error("Error dibujando espada:", e);
                }
            }
            
            // Dibujar ítems equipados
            if (p.userUID === currentUserUID) {
                if (debugMode) console.log("Dibujando ítems para jugador actual:", 
                                         Object.keys(itemImages).length > 0 ? "Hay ítems" : "No hay ítems");
                
                // Dibujar los ítems previamente cargados
                for (const itemId in itemImages) {
                    const item = itemImages[itemId];
                    
                    if (!item || !item.image) {
                        if (debugMode) console.warn(`Ítem inválido ${itemId}:`, item);
                        continue;
                    }
                    
                    if (debugMode) console.log(`Dibujando ítem ${itemId} en posición ${item.position}`);
                    
                    try {
                        // Dibujar según la posición
                        switch (item.position) {
                            case 'head':
                                ctx.drawImage(item.image, p.x - 25, p.y - 70, 50, 50);
                                break;
                            case 'torso':
                                ctx.drawImage(item.image, p.x - 25, p.y - 50, 50, 50);
                                break;
                            case 'legs':
                                ctx.drawImage(item.image, p.x - 25, p.y + 30, 50, 50);
                                break;
                            default:
                                ctx.drawImage(item.image, p.x - 25, p.y - 50, 50, 50);
                        }
                        
                        if (debugMode) console.log(`Ítem ${itemId} dibujado con éxito`);
                    } catch (e) {
                        console.error(`Error dibujando ítem ${itemId}:`, e);
                    }
                }
            }
        }
        
        // Continuar el bucle
        requestAnimationFrame(gameLoop);
    } catch (error) {
        console.error("Error en gameLoop:", error);
        // Intentar continuar a pesar del error
        requestAnimationFrame(gameLoop);
    }
}

// Escuchar cambios en la autenticación
auth.onAuthStateChanged(user => {
    if (user && user.uid) {
        if (debugMode) console.log("Usuario autenticado:", user.uid);
        // Inicializar el juego con el usuario actual
        initializePlayer(user.uid);
    } else {
        if (debugMode) console.log("Usuario no autenticado");
        // Usuario no autenticado
        currentUserUID = null;
    }
});
    
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Cargar imágenes
const playerImg = new Image();
playerImg.src = "player.png"; // Imagen del jugador
const swordImg = new Image();
swordImg.src = "https://tr.rbxcdn.com/463a028944c35811cdcd881b3a3a444b/420/420/Decal/Png"; // Imagen de la espada

// Jugador local
let player = { 
    id: null, 
    x: Math.random() * canvas.width, 
    y: Math.random() * canvas.height, 
    size: 50, 
    name: "", 
    health: 100, 
    hasSword: false 
};

let players = {};
let targetX = player.x, targetY = player.y;

auth.onAuthStateChanged(user => {
    if (user) {
        // Obtiene el ID del usuario
        player.id = user.uid;

        // Obtiene el 'nickname' del usuario desde la base de datos
        db.ref(`users/${user.uid}/nickname`).once('value', snapshot => {
            const nickname = snapshot.val(); // El valor del 'nickname'
            player.name = nickname || user.email.split("@")[0] || "Anónimo"; // Si no hay nickname, usa el email

            // Guarda el jugador en la base de datos bajo la ruta de players
            db.ref(`players/${player.id}`).set(player);
        });

        // Actualiza la lista de jugadores en tiempo real
        db.ref("players").on("value", snapshot => {
            players = snapshot.val() || {};
            updateLeaderboard();
        });
    }
});

        window.addEventListener("mousemove", e => {
            targetX = e.clientX;
            targetY = e.clientY;
        });

        window.addEventListener("beforeunload", () => {
            db.ref(`players/${player.id}`).remove();
        });

document.addEventListener("keydown", (e) => {
    if (e.key === "e") toggleSword();
    if (e.key === " ") attack();
});

gameLoop(); // Aquí llamas a la función gameLoop() correctamente.

function toggleSword() {
    player.hasSword = !player.hasSword;
    db.ref(`players/${player.id}/hasSword`).set(player.hasSword);
}

function attack() {
    if (!player.hasSword) return;
    
    for (const id in players) {
        if (id !== player.id) {
            const enemy = players[id];
            const distance = Math.hypot(player.x - enemy.x, player.y - enemy.y);
            if (distance < 60) { // Rango de ataque
                let newHealth = Math.max(0, enemy.health - 20);
                db.ref(`players/${id}/health`).set(newHealth);

                if (newHealth === 0) {
                    // Respawn del jugador muerto
                    db.ref(`players/${id}`).set({ 
                        id: id, 
                        x: Math.random() * canvas.width, 
                        y: Math.random() * canvas.height, 
                        size: 50, 
                        name: enemy.name, 
                        health: 100, 
                        hasSword: false 
                    });
                }
            }
        }
    }
}

function updateLeaderboard() {
    const leaderboard = document.getElementById("leaderboard");
    leaderboard.innerHTML = "<b>Leaderboard</b><br>";
    for (const id in players) {
        const p = players[id];
        leaderboard.innerHTML += `${p.name}: ${p.health} HP<br>`;
    }
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Calcular la dirección hacia el destino
    let dx = targetX - player.x;
    let dy = targetY - player.y;
    let distance = Math.hypot(dx, dy);

    // Mover solo si la distancia es mayor que la velocidad
    if (distance > speed) {
        player.x += (dx / distance) * speed;
        player.y += (dy / distance) * speed;
    } else {
        player.x = targetX;
        player.y = targetY;
    }

    for (const id in players) {
        const p = players[id];

        // Dibujar jugador
        ctx.drawImage(playerImg, p.x - 25, p.y - 25, 50, 50);

        // Dibujar nombre y vida
        ctx.fillStyle = "black";
        ctx.font = "14px Arial";
        ctx.fillText(p.name, p.x - 20, p.y - 30);
        ctx.fillText(`HP: ${p.health}`, p.x - 20, p.y + 40);

        // Dibujar espada si la tiene equipada
        if (p.hasSword) {
            ctx.drawImage(swordImg, p.x + 15, p.y, 40, 40);
        }
    }

    requestAnimationFrame(gameLoop);
}

// Actualizar base de datos cada segundo
setInterval(() => {
    db.ref(`players/${player.id}`).set(player);
}, 1000);
</script>

    <div id="controls">
    <button id="equipButton">Equipar Espada</button>
    <button id="unequipButton">Desequipar Espada</button>
    <button id="attackButton">Atacar</button>
</div>

<style>
    #controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
    }
    
    button {
        background-color: black;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }
    
    button:hover {
        background-color: gray;
    }
</style>

<script>
    document.getElementById("equipButton").addEventListener("click", () => {
        player.hasSword = true;
        db.ref(`players/${player.id}/hasSword`).set(true);
    });

    document.getElementById("unequipButton").addEventListener("click", () => {
        player.hasSword = false;
        db.ref(`players/${player.id}/hasSword`).set(false);
    });

    document.getElementById("attackButton").addEventListener("click", attack);
</script>

</body>
</html>
