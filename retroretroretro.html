<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>RETRO RETRO RETRO! – Evento BLOXPAST2D</title>
  <style>
    body { margin:0; padding:0; overflow:hidden; background:#222; font-family:Arial, sans-serif; color:white; }
    #gameCanvas { background:#2f2f3f; display:block; }
    #ui, #leaderboard, #minigame {
      position:absolute; background:rgba(0,0,0,0.7); padding:10px; border-radius:5px; font-size:14px;
    }
    #ui { bottom:20px; left:20px; }
    #leaderboard { top:20px; right:20px; width:150px; }
    #minigame { top:20px; left:20px; width:200px; }
    button { background:#444; color:white; border:none; padding:6px 10px; margin:4px; border-radius:3px; cursor:pointer; }
    button:hover { background:#666; }
    canvas { width:100vw; height:100vh; }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="leaderboard">Leaderboard<br>Loading...</div>
<div id="ui">
  Blocksgold: <span id="bgCount">0</span><br>
  <button onclick="startMinigame()">Iniciar Minijuego</button>
</div>
<div id="minigame" style="display:none;">
  <div id="mgTitle"></div>
  <div id="mgContent"></div>
  <button id="mgAction">¡Jugar!</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getDatabase, ref, onValue, set, update, get, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuWcUaYo9eah5mehCQ0h8bBnkE_251NKY",
  authDomain: "virtualblocks-b7a52.firebaseapp.com",
  databaseURL: "https://virtualblocks-b7a52-default-rtdb.firebaseio.com",
  projectId: "virtualblocks-b7a52",
  storageBucket: "virtualblocks-b7a52.appspot.com",
  messagingSenderId: "490618182453",
  appId: "1:490618182453:web:93385819c7ff08537d8a7c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// AUTENTICACIÓN ANÓNIMA
signInAnonymously(auth).catch(console.error);

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

let tileSize = 20;
let players = {}, me = {
  id: null, x: 100, y: 100,
  color: "#888", nickname: "Anon",
  avatarConfig: {}, equippedItems: {}, blocksgold: 0
};
let targetX = me.x, targetY = me.y;
const speed = 3;
let currentMini = null;
let playersCache = {};

addEventListener("mousemove", e => {
  targetX = e.clientX;
  targetY = e.clientY;
});
addEventListener("keydown", e => {
  if (e.key === "e" && me.id) toggleEquip();
});

onAuthStateChanged(auth, user => {
  if (!user) return;

  me.id = user.uid;
  const userRefPath = ref(db, `users/${me.id}`);
  const selfRef = ref(db, `players/${me.id}`);
  const playersRef = ref(db, "players");

  set(selfRef, { x: me.x, y: me.y });
  update(userRefPath, { isConnectedToGame1: true });

  get(child(ref(db), `users/${me.id}/nickname`)).then(s => {
    if (s.exists()) me.nickname = s.val();
  });

  onValue(userRefPath, snap => {
    const d = snap.val(); if (!d) return;
    me.avatarConfig = d.avatarConfig || {};
    me.equippedItems = d.equippedItems || {};
    me.blocksgold = d.blocksgold || 0;
    document.getElementById("bgCount").innerText = me.blocksgold;
  });

  onValue(playersRef, snap => {
    loadPlayersWithNicknames(snap.val());
    playersCache = snap.val() || {};
  });

  async function loadPlayersWithNicknames(data) {
    players = {};
    const promises = Object.keys(data || {}).map(async uid => {
      const nickSnap = await get(child(ref(db), `users/${uid}/nickname`));
      const nickname = nickSnap.exists() ? nickSnap.val() : uid;
      players[uid] = { ...data[uid], nickname };
    });
    await Promise.all(promises);
    updateLeaderboard();
  }

  setInterval(() => {
    set(selfRef, { x: me.x, y: me.y });
    update(userRefPath, { blocksgold: me.blocksgold });
  }, 500);

  requestAnimationFrame(render);
});

function render() {
  updatePosition();
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (const key in playersCache) {
    const p = playersCache[key];
    const x = p.x, y = p.y;

    ctx.fillStyle = (key === me.id) ? "blue" : "red";
    ctx.fillRect(x - tileSize / 2, y - tileSize / 2, tileSize, tileSize);

    const name = players[key]?.nickname || "Anon";
    ctx.fillStyle = "white";
    ctx.fillText(name, x - name.length * 3, y - 10);
  }

  if (currentMini && currentMini.drawZone) currentMini.drawZone();

  requestAnimationFrame(render);
}

function updatePosition() {
  const dx = targetX - me.x;
  const dy = targetY - me.y;
  const dist = Math.hypot(dx, dy);
  if (dist > 1) {
    me.x += dx / dist * speed;
    me.y += dy / dist * speed;
  }
}

function updateLeaderboard() {
  let html = "<b>Jugadores</b><br>";
  for (let uid in players) {
    html += (players[uid].nickname || uid) + "<br>";
  }
  document.getElementById("leaderboard").innerHTML = html;
}

// --- MINIJUEGOS ---
const minigames = {
  colorTile: {
    title: "Pisa el color correcto",
    start() {
      document.getElementById("minigame").style.display = "block";
      document.getElementById("mgTitle").innerText = this.title;
      document.getElementById("mgContent").innerHTML = `Presiona <b>ESPACIO</b> solo si estás sobre el <span style="color: red;">cuadro rojo</span>.`;
      document.getElementById("mgAction").onclick = () => {
        const p = players[me.id];
        const inside = p && p.x > 300 && p.x < 400 && p.y > 200 && p.y < 300;
        reward(inside ? 10 : 0);
        endMini();
      };
    },
    drawZone() {
      ctx.strokeStyle = "red";
      ctx.strokeRect(300, 200, 100, 100);
    }
  }
};

function startMinigame() {
  if (currentMini) return;
  currentMini = minigames.colorTile;
  currentMini.start();
}

function reward(amount) {
  if (amount > 0) {
    me.blocksgold += amount;
    showToast(`¡Ganaste ${amount} BLOCKSGOLD!`);
  } else {
    showToast("Fallaste, sigue intentando.");
  }
}

function endMini() {
  currentMini = null;
  document.getElementById("minigame").style.display = "none";
}

function showToast(msg) {
  const div = document.createElement("div");
  div.innerText = msg;
  Object.assign(div.style, {
    position: "fixed", bottom: "50px", left: "50%",
    transform: "translateX(-50%)", background: "#333",
    color: "#fff", padding: "10px", borderRadius: "5px",
    zIndex: "9999"
  });
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 2000);
}
</script>
</body>
</html>
